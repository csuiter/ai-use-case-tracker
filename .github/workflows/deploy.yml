name: AI Use Case Tracker - Deploy

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install ServiceNow SDK
        run: npm install -g @servicenow/sdk@4.3.0
      - name: Build
        run: npx @servicenow/cli build

  deploy-dev:
    name: Deploy to DEV
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: development
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'
      - name: Install SDK
        run: npm install -g @servicenow/sdk@4.3.0
      - name: Build
        run: npx @servicenow/cli build
      - name: Deploy to DEV instance
        run: |
          npx @servicenow/cli deploy \
            --instance ${{ secrets.SN_DEV_INSTANCE_URL }} \
            --username ${{ secrets.SN_DEV_USERNAME }} \
            --password ${{ secrets.SN_DEV_PASSWORD }}

  deploy-prod:
    name: Deploy to PROD
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'
      - name: Install SDK
        run: npm install -g @servicenow/sdk@4.3.0
      - name: Build
        run: npx @servicenow/cli build
      - name: Deploy to PROD instance
        run: |
          npx @servicenow/cli deploy \
            --instance ${{ secrets.SN_PROD_INSTANCE_URL }} \
            --username ${{ secrets.SN_PROD_USERNAME }} \
            --password ${{ secrets.SN_PROD_PASSWORD }}
